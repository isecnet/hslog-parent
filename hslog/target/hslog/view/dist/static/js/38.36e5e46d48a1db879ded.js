webpackJsonp([38],{"9pxy":function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n("/sA3"),i={name:"networkTopology",data:function(){return{timepicker:"",pickerOptions:{shortcuts:[{text:"最近一周",onClick:function(t){var e=new Date,n=new Date;n.setTime(n.getTime()-6048e5),t.$emit("pick",[n,e])}},{text:"最近一个月",onClick:function(t){var e=new Date,n=new Date;n.setTime(n.getTime()-2592e6),t.$emit("pick",[n,e])}},{text:"最近三个月",onClick:function(t){var e=new Date,n=new Date;n.setTime(n.getTime()-7776e6),t.$emit("pick",[n,e])}}]},zoomHandler:null}},mounted:function(){var t=new Date,e=(t.toLocaleDateString(),t.getFullYear()),n=t.getMonth()+1,r=t.getDate();n<10&&(n="0"+n),r<10&&(r="0"+r);var i=new Date(t);i.setDate(t.getDate()-7);var a=i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate(),c=e+"-"+n+"-"+r;this.timepicker=[a,c],this.getNetflowTopologyData(this.timepicker)},methods:{getNetflowTopologyData:function(t){var e=this;layer.load(1),this.$nextTick(function(){e.$axios.post(e.$baseUrl+"/log/getNetworkTopological.do",e.$qs.stringify({starttime:t[0],endtime:t[1]})).then(function(t){layer.closeAll(),$("#cy").html("");var n=$("#cy").width(),i=$("#cy").height(),a=d3.select("#cy").append("svg").attr("width",n).attr("height",i).call(d3.zoom().scaleExtent([.1,10]).on("zoom",function(){o.attr("transform",d3.event.transform)}));console.log(d3.event);var c,o=a.append("g").attr("width",n).attr("height",i).attr("x","0").attr("y","0").attr("class","relMap_g"),l=d3.scaleOrdinal(d3.schemeCategory20),s=d3.forceSimulation().force("link",d3.forceLink().id(function(t){return t.id})).force("collide",d3.forceCollide(100).strength(.1).iterations(10)).force("center",d3.forceCenter(n/2,i/2)),u="",d=t.data,f={},p=[],g=[],y=[],h=[];d[0].data.forEach(function(t){y.push(t.count),p.push({id:t.name,count:t.count})}),u=Math.max.apply(null,y),d[0].links.forEach(function(t){h.push(t.count)}),c=Math.max.apply(null,h),f.nodes=p,f.links=d[0].links;a.append("defs").append("marker").attr("id","resolved").attr("markerUnits","strokeWidth").attr("viewBox","0 -5 10 10").attr("orient","auto").attr("stroke-width",1).append("path").attr("d","M0,-5L10,0L0,5").attr("fill","#65f9fd");var x=o.selectAll("g.edge").data(f.links).enter().append("g").attr("class","edge");x.append("title").text(function(t){return t.count});g=x.append("path").attr("class","links").style("marker-mid","url(#resolved)").style("stroke","#65f9fd").style("stroke-width",function(t){var e=10*t.count/c;return t.w=e<2?2:e,t.w}).on("mouseenter",function(t){d3.select(this).style("stroke-width",t.w+4);var e=[t.index];a.selectAll(".edge").filter(function(t){return-1==e.indexOf(t.index)}).style("opacity",.1);var n=[t.source.index,t.target.index];a.selectAll(".node").filter(function(t){return-1==n.indexOf(t.index)}).style("opacity",.1)}).on("mouseleave",function(t){d3.select(this).style("stroke-width",t.w),a.selectAll(".node").filter(function(t){return!0}).style("opacity",1),a.selectAll(".edge").filter(function(t){return!0}).style("opacity",1)}).on("click",function(t){e.edgeClick(t)});var k=x.append("g").attr("class","linkText").append("text").attr("fill","#fff").style("font-weight","600").text(function(t){return t.count}),m=o.selectAll(".node").data(f.nodes).enter().append("g").attr("class","node").on("mouseenter",function(t){d3.select(this).selectAll("circle").attr("stroke-width","8"),d3.select(this).selectAll("circle").attr("stroke","#a3e5f9");var e=[],n=[],r=t.index;e=e.concat([r]),n=n.concat([r]),f.links.forEach(function(t){r==t.source.index?e=e.concat([t.target.index]):r==t.target.index&&(e=e.concat([t.source.index]))}),a.selectAll(".node").filter(function(t){return-1==e.indexOf(t.index)}).style("opacity",.01),a.selectAll(".edge").filter(function(t){return-1==n.indexOf(t.source.index)&&-1==n.indexOf(t.target.index)}).style("opacity",.01)}).on("mouseleave",function(t){d3.select(this).selectAll("circle").attr("stroke-width","0"),a.selectAll(".node").filter(function(t){return!0}).style("opacity",1),a.selectAll(".edge").filter(function(t){return!0}).style("opacity",1)}).on("click",function(t){e.nodeClick(t)});m.append("circle").attr("r",function(t){var e=100*t.count/u;return t.w=e<20?20:e,t.w}).attr("fill",function(t){return t.count==u?"#ff7f0e":"#59c9a5"}).attr("stroke",function(t){return l(t.count)}),m.append("text").attr("font-family","微软雅黑").attr("text-anchor","middle").attr("fill","#fff").style("font-weight","600").attr("dy",function(){return"0em"}).attr("x",function(t){d3.select(this).append("tspan").text(function(){return t.id}),d3.select(this).append("tspan").attr("x",0).attr("y",14).text(function(){return"活跃度："+t.count})}),s.nodes(f.nodes).on("tick",function(){g.attr("d",function(t){var e=t.target.x-t.source.x,n=t.target.y-t.source.y,r=Math.sqrt(e*e+n*n);return"M"+t.source.x+","+t.source.y+"A"+r+","+r+" 0 0,0 "+t.target.x+","+t.target.y}).attr("fill","transparent"),k.attr("transform",function(t){var e=t.target.x-t.source.x,n=t.target.y-t.source.y,i=Math.sqrt(e*e+n*n),a=Object(r.a)([t.source.x,t.source.y],[t.target.x,t.target.y],i),c=[];t.source.x<t.target.x&&t.source.y>t.target.y?c=[a[2],a[3]]:t.source.x>t.target.x&&t.source.y>t.target.y?c=[a[2],a[3]]:t.source.x<t.target.x&&t.source.y<t.target.y?c=[a[0],a[1]]:t.source.x>t.target.x&&t.source.y<t.target.y&&(c=[a[0],a[1]]);var o=(t.source.x-c[0])*Math.cos(-3.14/6)-(t.source.y-c[1])*Math.sin(-3.14/6)+c[0],l=(t.source.x-c[0])*Math.sin(-3.14/6)+(t.source.y-c[1])*Math.cos(-3.14/6)+c[1];return"translate("+o+","+l+")"}),m.attr("transform",function(t){return t.count==u&&(t.x=n/2,t.y=i/2),"translate("+t.x+","+t.y+")"})}),s.force("link").links(f.links)}).catch(function(t){layer.closeAll(),layer.msg("获取信息失败",{icon:5})})})},nodeClick:function(t){this.exitFullScreen();var e={};e.val=t.id,e.type="ip",e.kname="multifield_ip",e.clickType="node",Object(r.f)("flowLogs"+e.val,"logsManage/flowLogs.vue",e,"日志")},edgeClick:function(t){this.exitFullScreen();var e={};e.val=t.source.id+"-"+t.target.id,e.ipv4_src_addr=t.source.id,e.ipv4_dst_addr=t.target.id,e.clickType="link",e.type="ip",Object(r.f)("flowLogs"+e.ipv4_src_addr+"-"+e.ipv4_dst_addr,"logsManage/flowLogs.vue",e,"日志")},fullScreen:function(){var t=document.getElementById("cy"),e=t.requestFullScreen||t.webkitRequestFullScreen||t.mozRequestFullScreen||t.msRequestFullScreen,n=void 0;console.log(t),void 0!==e&&e?e.call(t):void 0!==window.ActiveXObject&&(n=new ActiveXObject("WScript.Shell"))&&n.SendKeys("{F11}")},exitFullScreen:function(){var t,e=document,n=e.cancelFullScreen||e.webkitCancelFullScreen||e.mozCancelFullScreen||e.exitFullScreen;void 0!==n&&n?n.call(e):void 0!==window.ActiveXObject&&null!=(t=new ActiveXObject("WScript.Shell"))&&t.SendKeys("{F11}")},timepickerChange:function(){null===this.timepicker&&(this.timepicker=["",""]),this.getNetflowTopologyData(this.timepicker)}}},a={render:function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"content-bg"},[n("div",{staticClass:"top-title"},[t._v("业务流分析\n        "),n("i",{staticClass:"el-icon-rank el-tooltip fullScreen",attrs:{title:"全屏观看视图",tabindex:"0"},on:{click:function(e){return t.fullScreen()}}}),t._v(" "),n("el-date-picker",{staticStyle:{float:"right","margin-top":"10px","margin-right":"10px"},attrs:{type:"daterange",align:"right","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"yyyy-MM-dd","picker-options":t.pickerOptions},on:{change:t.timepickerChange},model:{value:t.timepicker,callback:function(e){t.timepicker=e},expression:"timepicker"}})],1),t._v(" "),t._m(0)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"topology-wapper"},[e("div",{attrs:{id:"cy"}})])}]};var c=n("C7Lr")(i,a,!1,function(t){n("x8EB")},"data-v-3d301ffd",null);e.default=c.exports},x8EB:function(t,e){}});